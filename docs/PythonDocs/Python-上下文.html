<!DOCTYPE html>
<html lang="en">
<html>

<head>
  <meta charset="UTF-8">
  <link href="/.static/css/primer.css" rel="stylesheet" />
  <link rel="stylesheet alternate" href="/.static/css/github-light.css" id="light-hl">
  <link rel="stylesheet alternate" href="/.static/css/github-dark.css" id="dark-hl">

  <title>Python-ä¸Šä¸‹æ–‡.md</title>
</head>

<body id="markdown-body" data-color-mode="light" data-dark-theme="light">
  <div class="
        Box
        md
        js-code-block-container
        Box--responsive
        container-xl
        px-3 px-md-4 px-lg-5
        mt-5
      " id="content">
    <div class="Box-body px-5 pb-5">
      <div class="d-flex flex-column flex-sm-row-reverse">
        <div>
          <button id="theme-button" class="btn" type="button">
            <span id="theme-icon" class="iconify" data-icon="octicon:sun-16"></span>
          </button>
        </div>
      </div>
      <article class="markdown-body entry-content container-lg" itemprop="text">
        <h3><a id="user-content-ä¸€ç®€ä»‹" class="anchor" aria-hidden="true" href="#ä¸€ç®€ä»‹"><span aria-hidden="true" class="octicon octicon-link"></span></a>ä¸€ã€ç®€ä»‹</h3>
<ol>
<li>
<p>çœ‹çœ‹å®šä¹‰ ~</p>
<p>çœ‹å•¥å“¦ ~ ï¼Œçœ‹å•¥å“¦ï¼Œå…ˆçœ‹æ®µä»£ç ï¼Œä½ ä¸€å®šç†Ÿæ‚‰ ~</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># PythonDocs/src/021.py</span>

<span class="pl-k">with</span> <span class="pl-en">open</span>(<span class="pl-s">'log.txt'</span>, <span class="pl-s">'r'</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>) <span class="pl-k">as</span> <span class="pl-s1">f</span>:
    <span class="pl-s1">data</span> <span class="pl-c1">=</span> <span class="pl-s1">f</span>.<span class="pl-en">read</span>()

<span class="pl-en">print</span>(<span class="pl-s1">data</span>)</pre></div>
<p>è¿™ä¸ª<code>with</code>çœ‹èµ·æ¥å¾ˆå¥‡æ€ªå“¦ï¼Œäº‹å®ä¸Šå¯¹ä¸€ä¸ªæ–‡ä»¶çš„æ“ä½œä¹Ÿå¯ä»¥è¿™ä¸ªæ ·~</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># PythonDocs/src/021.py</span>

<span class="pl-s1">fObj</span> <span class="pl-c1">=</span> <span class="pl-en">open</span>(<span class="pl-s">'log.txt'</span>, <span class="pl-s">'r'</span>, <span class="pl-s1">encoding</span><span class="pl-c1">=</span><span class="pl-s">'utf-8'</span>)
<span class="pl-s1">data_content</span> <span class="pl-c1">=</span> <span class="pl-s1">fObj</span>.<span class="pl-en">read</span>()
<span class="pl-s1">fObj</span>.<span class="pl-en">close</span>()
<span class="pl-en">print</span>(<span class="pl-s1">data_content</span>)</pre></div>
<p>æ€ä¹ˆçœ‹ä¸Šé¢çš„æ–¹æ¡ˆéƒ½æ›´ä¼˜é›…~</p>
</li>
<li>
<p>è‡ªå®šä¹‰ä¸Šä¸‹æ–‡</p>
<p>å®˜æ–¹è¯´ï¼Œåœ¨å†…éƒ¨å®ç°<code>__enter__</code>åŠ<code>__exit__</code>æ–¹æ³•å³å¯å“¦ï¼Œé‚£æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•å®ç°~</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># PythonDocs/src/022.py</span>

<span class="pl-k">class</span> <span class="pl-v">Foo</span>():
    <span class="pl-k">def</span> <span class="pl-en">run</span>(<span class="pl-s1">self</span>):
        <span class="pl-en">print</span>(<span class="pl-s">f"æˆ‘æ˜¯<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">self</span><span class="pl-kos">}</span></span>"</span>)

    <span class="pl-k">def</span> <span class="pl-en">__enter__</span>(<span class="pl-s1">self</span>):
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">self</span><span class="pl-kos">}</span></span>è¢«æ‰“å¼€äº†~"</span>)
        <span class="pl-k">return</span> <span class="pl-s1">self</span>

    <span class="pl-k">def</span> <span class="pl-en">__exit__</span>(<span class="pl-s1">self</span>, <span class="pl-s1">exc_type</span>, <span class="pl-s1">exc_val</span>, <span class="pl-s1">exc_tb</span>):
        <span class="pl-en">print</span>(<span class="pl-s">f"<span class="pl-s1"><span class="pl-kos">{</span><span class="pl-s1">self</span><span class="pl-kos">}</span></span>è¢«å…³é—­äº†~"</span>)


<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">'__main__'</span>:
    <span class="pl-k">with</span> <span class="pl-v">Foo</span>() <span class="pl-k">as</span> <span class="pl-s1">obj</span>:
        <span class="pl-s1">obj</span>.<span class="pl-en">run</span>()
        
<span class="pl-c"># ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„ç»“æœå“¦~   </span>

<span class="pl-c"># &lt;__main__.Foo object at 0x1025d5a60&gt;è¢«æ‰“å¼€äº†~</span>
<span class="pl-c"># æˆ‘æ˜¯&lt;__main__.Foo object at 0x1025d5a60&gt;</span>
<span class="pl-c"># &lt;__main__.Foo object at 0x1025d5a60&gt;è¢«å…³é—­äº†~</span></pre></div>
<p>çœ‹èµ·æ¥å¥½åƒæ˜¯å…ˆè°ƒç”¨äº†<code>__enter__</code>æ–¹æ³•ï¼Œç„¶åå»æ‰§è¡Œæˆ‘ä»¬çš„è‡ªå®šä¹‰å†…å®¹ï¼Œæœ€åæ‰§è¡Œ<code>__exit__</code>æ–¹æ³•å†…çš„å†…å®¹ï¼Œä¸€èˆ¬å¯¹äºæœ‰å…³è”çš„ä¸¤ä»¶äº‹æƒ…ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸Šä¸‹æ–‡è®©ä»–ä»¬é“¾æ¥ï¼Œé¿å…æ“ä½œä¸Šçš„å¤±è¯¯å“¦~</p>
</li>
<li>
<p>è¿˜æœ‰æ²¡æœ‰åˆ«çš„å†™æ³•ï¼Ÿ</p>
<p>è¿˜çœŸæœ‰ï¼Œé¢è¯•è¢«é—®åˆ°ï¼Œä¹¦ä¸Šçœ‹åˆ°è¿‡ï¼Œå¿˜è®°äº†ï¼Œemmmmï¼Œå†™ä¸€ä¸ª~</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># PythonDocs/src/023.py</span>

<span class="pl-k">from</span> <span class="pl-s1">contextlib</span> <span class="pl-k">import</span> <span class="pl-s1">contextmanager</span>


<span class="pl-en">@<span class="pl-s1">contextmanager</span></span>
<span class="pl-k">def</span> <span class="pl-en">func</span>():
    <span class="pl-en">print</span>(<span class="pl-s">"æˆ‘åˆå¼€å§‹äº†~"</span>)
    <span class="pl-k">try</span>:
        <span class="pl-k">yield</span> <span class="pl-c1">1</span>
    <span class="pl-k">finally</span>:
        <span class="pl-en">print</span>(<span class="pl-s">"å®Œäº‹äº†~, çœ‹"</span>)


<span class="pl-k">if</span> <span class="pl-s1">__name__</span> <span class="pl-c1">==</span> <span class="pl-s">'__main__'</span>:
    <span class="pl-k">with</span> <span class="pl-en">func</span>() <span class="pl-k">as</span> <span class="pl-s1">f</span>:
        <span class="pl-en">print</span>(<span class="pl-s1">f</span>)</pre></div>
<p>è¦æ˜¯ç•™å¿ƒæ€çœ‹ä¸‹æºç ï¼Œä½ å°±ä¼šå‘ç°ï¼Œè¿™ä¸ªç©æ„è¿˜æ˜¯ä¸¢åˆ°<code>__enter__</code>åŠ<code>__exit__</code>é‡Œé¢å»äº†~</p>
<div class="highlight highlight-source-python"><pre><span class="pl-c"># æºç å†…å®¹ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±çœ‹ä¸‹å“¦~</span>

<span class="pl-k">def</span> <span class="pl-en">contextmanager</span>(<span class="pl-s1">func</span>):
    <span class="pl-en">@<span class="pl-en">wraps</span>(<span class="pl-s1">func</span>)</span>
    <span class="pl-k">def</span> <span class="pl-en">helper</span>(<span class="pl-c1">*</span><span class="pl-s1">args</span>, <span class="pl-c1">**</span><span class="pl-s1">kwds</span>):
        <span class="pl-k">return</span> <span class="pl-en">_GeneratorContextManager</span>(<span class="pl-s1">func</span>, <span class="pl-s1">args</span>, <span class="pl-s1">kwds</span>)
    <span class="pl-k">return</span> <span class="pl-s1">helper</span>
  
<span class="pl-k">class</span> <span class="pl-s1">_GeneratorContextManager</span>(<span class="pl-s1">_GeneratorContextManagerBase</span>,
                               <span class="pl-v">AbstractContextManager</span>,
                               <span class="pl-v">ContextDecorator</span>):
    <span class="pl-k">def</span> <span class="pl-en">_recreate_cm</span>(<span class="pl-s1">self</span>):
        <span class="pl-k">return</span> <span class="pl-s1">self</span>.<span class="pl-en">__class__</span>(<span class="pl-s1">self</span>.<span class="pl-s1">func</span>, <span class="pl-s1">self</span>.<span class="pl-s1">args</span>, <span class="pl-s1">self</span>.<span class="pl-s1">kwds</span>)

    <span class="pl-k">def</span> <span class="pl-en">__enter__</span>(<span class="pl-s1">self</span>):
        <span class="pl-k">del</span> <span class="pl-s1">self</span>.<span class="pl-s1">args</span>, <span class="pl-s1">self</span>.<span class="pl-s1">kwds</span>, <span class="pl-s1">self</span>.<span class="pl-s1">func</span>
        <span class="pl-k">try</span>:
            <span class="pl-k">return</span> <span class="pl-en">next</span>(<span class="pl-s1">self</span>.<span class="pl-s1">gen</span>)
        <span class="pl-k">except</span> <span class="pl-v">StopIteration</span>:
            <span class="pl-k">raise</span> <span class="pl-v">RuntimeError</span>(<span class="pl-s">"generator didn't yield"</span>) <span class="pl-k">from</span> <span class="pl-c1">None</span>

    <span class="pl-k">def</span> <span class="pl-en">__exit__</span>(<span class="pl-s1">self</span>, <span class="pl-s1">type</span>, <span class="pl-s1">value</span>, <span class="pl-s1">traceback</span>):
        <span class="pl-k">if</span> <span class="pl-s1">type</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
            <span class="pl-k">try</span>:
                <span class="pl-en">next</span>(<span class="pl-s1">self</span>.<span class="pl-s1">gen</span>)
            <span class="pl-k">except</span> <span class="pl-v">StopIteration</span>:
                <span class="pl-k">return</span> <span class="pl-c1">False</span>
            <span class="pl-k">else</span>:
                <span class="pl-k">raise</span> <span class="pl-v">RuntimeError</span>(<span class="pl-s">"generator didn't stop"</span>)
        <span class="pl-k">else</span>:
            <span class="pl-k">if</span> <span class="pl-s1">value</span> <span class="pl-c1">is</span> <span class="pl-c1">None</span>:
                <span class="pl-s1">value</span> <span class="pl-c1">=</span> <span class="pl-en">type</span>()
            <span class="pl-k">try</span>:
                <span class="pl-s1">self</span>.<span class="pl-s1">gen</span>.<span class="pl-en">throw</span>(<span class="pl-s1">type</span>, <span class="pl-s1">value</span>, <span class="pl-s1">traceback</span>)
            <span class="pl-k">except</span> <span class="pl-v">StopIteration</span> <span class="pl-k">as</span> <span class="pl-s1">exc</span>:
                <span class="pl-k">return</span> <span class="pl-s1">exc</span> <span class="pl-c1">is</span> <span class="pl-c1">not</span> <span class="pl-s1">value</span>
            <span class="pl-k">except</span> <span class="pl-v">RuntimeError</span> <span class="pl-k">as</span> <span class="pl-s1">exc</span>:
                <span class="pl-k">if</span> <span class="pl-s1">exc</span> <span class="pl-c1">is</span> <span class="pl-s1">value</span>:
                    <span class="pl-k">return</span> <span class="pl-c1">False</span>
                <span class="pl-k">if</span> <span class="pl-s1">type</span> <span class="pl-c1">is</span> <span class="pl-v">StopIteration</span> <span class="pl-c1">and</span> <span class="pl-s1">exc</span>.<span class="pl-s1">__cause__</span> <span class="pl-c1">is</span> <span class="pl-s1">value</span>:
                    <span class="pl-k">return</span> <span class="pl-c1">False</span>
                <span class="pl-k">raise</span>
            <span class="pl-k">except</span>:
                <span class="pl-k">if</span> <span class="pl-s1">sys</span>.<span class="pl-en">exc_info</span>()[<span class="pl-c1">1</span>] <span class="pl-c1">is</span> <span class="pl-s1">value</span>:
                    <span class="pl-k">return</span> <span class="pl-c1">False</span>
                <span class="pl-k">raise</span>
            <span class="pl-k">raise</span> <span class="pl-v">RuntimeError</span>(<span class="pl-s">"generator didn't stop after throw()"</span>)</pre></div>
</li>
</ol>
<h3><a id="user-content-äºŒåº”ç”¨" class="anchor" aria-hidden="true" href="#äºŒåº”ç”¨"><span aria-hidden="true" class="octicon octicon-link"></span></a>äºŒã€åº”ç”¨</h3>
<ol>
<li>
<p>ä¸¾ä¸ª<g-emoji class="g-emoji" alias="chestnut" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f330.png">ğŸŒ°</g-emoji>ï¼Œå’±ä»¬åœ¨ä½¿ç”¨flaskæ¡†æ¶ç¼–å†™webåº”ç”¨æ—¶ï¼Œå¤šæ•°å°ä¼™ä¼´ä¼šé€‰æ‹©flask-sqlalchemyè¿™ä¸ªæ’ä»¶å®ç°å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œå¾ˆå¤šå°ä¼™ä¼´å°å°ä¼šå†™å‡ºè¿™æ ·çš„ä»£ç (:)å·ç¬‘)</p>
<div class="highlight highlight-source-python"><pre><span class="pl-s1">user</span> <span class="pl-c1">=</span> <span class="pl-v">User</span>(.....)
<span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">add</span>(<span class="pl-s1">user</span>)
<span class="pl-k">try</span>:
    <span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">commit</span>()
<span class="pl-k">except</span>:
    <span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">rollback</span>()</pre></div>
<p>å½“ç„¶å•¦ï¼Œé…±ç´«å†™æ˜¯æ²¡æœ‰ä»»ä½•æ¯›ç—…æ»´ï¼Œå¯æ˜¯æ¯æ¬¡åˆ›å»ºä¸€ä¸ªmodelå¯¹è±¡éƒ½è¦è¿™æ ·å¼ç´¯å“¦ï¼Œä¸æ˜¯å˜›ï¼Ÿ</p>
<p>äºæ˜¯æœ‰äº†è¿™æ ·çš„å†™æ³• :)</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">def</span> <span class="pl-en">db_session_commit</span>():
    <span class="pl-k">try</span>:
        <span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">commit</span>()
        <span class="pl-k">return</span> <span class="pl-c1">True</span>
    <span class="pl-k">except</span>:
        <span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">rollback</span>()
        <span class="pl-k">return</span> <span class="pl-c1">False</span>

<span class="pl-s1">user</span> <span class="pl-c1">=</span> <span class="pl-v">User</span>(....)
<span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">add</span>(<span class="pl-s1">user</span>)
<span class="pl-en">db_session_commit</span>()	<span class="pl-c"># å¯ä»¥å¤šæ¬¡å¤ç”¨ï¼Œå€’ä¹Ÿæ˜¯çœäº‹äº†ä¸å°‘</span></pre></div>
<p>é‚£ä¹ˆè¿˜æœ‰æ²¡æœ‰å…¶ä»–çš„æ–¹æ¡ˆå‘¢ï¼Ÿå½“ç„¶æœ‰æ¥ï¼Œçœ‹çœ‹è¿™ä¸ª</p>
<div class="highlight highlight-source-python"><pre><span class="pl-k">from</span> <span class="pl-s1">contextlib</span> <span class="pl-k">import</span> <span class="pl-s1">contextmanager</span>
<span class="pl-k">from</span> <span class="pl-s1">flask_sqlalchemy</span> <span class="pl-k">import</span> <span class="pl-v">SQLAlchemy</span> <span class="pl-k">as</span> <span class="pl-s1">_SQLAlchemy</span>


<span class="pl-k">class</span> <span class="pl-v">SQLAlchemy</span>(<span class="pl-s1">_SQLAlchemy</span>):

    <span class="pl-en">@<span class="pl-s1">contextmanager</span></span>
    <span class="pl-k">def</span> <span class="pl-en">auto_save</span>(<span class="pl-s1">self</span>):
        <span class="pl-k">try</span>:
            <span class="pl-k">yield</span>
            <span class="pl-s1">self</span>.<span class="pl-s1">session</span>.<span class="pl-en">commit</span>()
        <span class="pl-k">except</span>:
            <span class="pl-s1">self</span>.<span class="pl-s1">session</span>.<span class="pl-en">rollback</span>()

<span class="pl-s1">user</span> <span class="pl-c1">=</span> <span class="pl-v">User</span>(....)
<span class="pl-k">with</span> <span class="pl-s1">db</span>.<span class="pl-en">auto_save</span>():
    <span class="pl-s1">db</span>.<span class="pl-s1">session</span>.<span class="pl-en">add</span>(<span class="pl-s1">user</span>)</pre></div>
<p>çœ‹èµ·æ¥å¥½åƒé«˜å¤§ä¸Šäº†ä¸å°‘å“¦~ å“¦åš¯åš¯åš¯</p>
</li>
</ol>

      </article>
    </div>
  </div>
  <script src="/.static/js/theme.js"></script>
  <script src="/.static/js/iconify.min.js"></script>
</body>

</html>